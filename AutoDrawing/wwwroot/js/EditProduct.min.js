var vatGroupList, dndMoveItem, loading = $("#Loading"); function initialize() { var t = $("#MenuBar"), a = t.find("ol.breadcrumb"), e = $("<li>", { class: "breadcrumb-item" }); a.append(e); var r = $("<a>", { href: "/Products/Index", text: "Product" }); e.append(r); var n = $("#Model").val(); e = $("<li>", { class: "breadcrumb-item active", text: n }), a.append(e); var o = t.find(".btn-group"), i = $("<div>", { class: "btn-group mr-3" }); o.before(i); var d = $("<button>", { type: "button", class: "btn danger-color text-white", "data-toggle": "modal", "data-target": "#DivDeleteParts", text: "DELETE" }); i.append(d), d.on("click", function () { var t = new Array; t.push($("#ProductId").val()), $.ajax({ type: "POST", url: "/Products/DeleteProduct", data: { json: JSON.stringify(t) }, success: function (t) { "Success" === t ? location.href = "/Products" : alert(t) } }) }) } function LoadComponent(t) { var a = $("#ProductId").val(); $.getJSON("/Products/LoadComponent", { id: a }).done(function (a) { var e = $("#ComponentList"); e.empty(), $.each(a, function () { var t = this.Id, a = this.Name, r = this.Variants, n = $("<div>", { class: "card" }); e.append(n); var o = $("<div>", { class: "card-header", text: a }); n.append(o); var i = $("<input>", { type: "hidden", value: t, class: "variantGroup" }); o.append(i); var d = $("<div>", { class: "card-body p-0" }); n.append(d); var c = $("<table>", { class: "table table-hover" }); d.append(c); var s = $("<thead>"); c.append(s); var p = $("<tr>"); s.append(p); for (var u = 0; u < 6; u++) { var l = $("<th>"); switch (p.append(l), u) { case 0: var v = $("<input>", { type: "checkbox", class: "mr-3" }); l.append(v); var h = $("<span>", { text: "Def." }); l.append(h); break; case 1: h = $("<span>", { text: "Name" }), l.append(h); break; case 2: h = $("<span>", { text: "Type" }), l.append(h); break; case 3: h = $("<span>", { text: "Q'ty" }), l.append(h); break; case 4: h = $("<span>", { text: "Mass" }), l.append(h); break; case 5: h = $("<span>", { text: "Remark" }), l.append(h) } } var f = $("<tbody>"); c.append(f), $.each(r, function () { var t = $("<tr>", { "data-id": this.Id, class: "cursor-default", draggable: !0, ondragstart: "DragStart(event)", ondragover: "DragOver(event)", ondragleave: "DragLeave(event)", ondrop: "Drop(event)" }); f.append(t), t.on("dblclick", function () { var t = $(this).attr("data-id"); $("#EditVariantId").val(t), $("#DivEditPart").modal() }); for (var a = 0; a < 6; a++) { var e = $("<td>"); switch (t.append(e), a) { case 0: var r = $("<input>", { type: "checkbox", value: this.Id, class: "mr-3" }); e.append(r); var n = this.Default; if (!isEmpty(n)) { var o = $("<span>", { text: n, class: "default" }); e.append(o) } break; case 1: var i = this.VariantName; o = $("<span>", { text: i }), e.append(o); break; case 2: var d = this.ProductModel; o = $("<span>", { text: d }), e.append(o); break; case 3: var c = isEmpty(this.Qty) ? "" : this.Qty; "Meter" === this.Unit && (c += " m"), o = $("<span>", { text: c }), e.append(o); break; case 4: var s = this.Mass; isEmpty(s) || (o = $("<span>", { text: s }), e.append(o)); break; case 5: var p = this.Remark; isEmpty(p) || (o = $("<span   >", { text: p }), e.append(o)) } } }) }), null !== t && $.each(t, function () { var t = $('#TbComponent > tbody > tr[data-id="' + this + '"] > td > input[type="checkbox"]'); $(t).trigger("click") }), LoadManual() }).fail(function (t, a, e) { var r = a + ", " + e; console.log("Request Failed: " + r) }) } function SearchParts() { var t = $("#SearchPart").val(); $.getJSON("/Products/SearchPart", { strFilter: t }).done(function (t) { var a = $("#SearchPartList"); a.empty(), $.each(t, function () { var t = this.Id, e = this.Model + " [" + this.Name + "]", r = $("<button>", { type: "button", class: "btn btn-light w-100 component", value: t, text: e, title: e }); a.prepend(r), r.on("click", function () { AddPart($(this)) }) }), setTimeout(function () { $("#SearchPart").focus() }, 0) }) } function AddPart(t) { var a = $("#SelectParts"), e = $("<div>", { class: "form-group row" }); a.prepend(e); var r = $("<div>", { class: "col pr-0" }); e.append(r); var n = $("<select>", { class: "vatGroup" }); r.append(n), $.each(vatGroupList, function () { var t = $("<option>", { value: this.Id, text: this.Name }); n.append(t) }), SelectLJH(n); var o = $("<div>", { class: "col pl-0" }); e.append(o), $(t).clone().appendTo(o).on("click", function () { $(this).parent().parent().remove() }) } function LoadVariantGroup() { $.getJSON("/Products/LoadVariantGroup", function (t) { var a = $("#VariantGroupList"); $.each(t, function () { var t = this.Id, e = this.Name, r = $("<button>", { type: "button", value: t, text: e, class: "btn btn-light w-100" }); a.prepend(r), r.on("click", function () { var t = $(this).val(); $.ajax({ url: "/Products/RemoveVariantGroup", type: "POST", data: { id: t }, success: function () { toastr.success("Success remove"), LoadVariantGroup() }, error: function (t) { toastr.error(t) } }) }) }) }) } function LoadManual() { var t = $("#ProductId").val(); $.getJSON("/Products/LoadManual", { id: t }).fail(function (t, a, e) { var r = a + ", " + e; toastr.error("Request Failed: " + r) }) } function DragStart(t) { dndMoveItem = $(t.currentTarget) } function DragOver(t) { t.preventDefault && t.preventDefault(), dndTargetItem = $(t.currentTarget), dndTargetItem.addClass("dragOver") } function DragLeave(t) { dndTargetItem.removeClass("dragOver") } function Drop(t) { dndTargetItem.before(dndMoveItem), dndTargetItem.removeClass("dragOver"); var a = $("#ComponentList table"), e = new Array; $.each(a, function () { var t = $(this).parent().siblings().find('input[type="hidden"]').val(), a = $(this).find("tbody").find("tr"), r = new Array; $.each(a, function () { var t = $(this).attr("data-id"); r.push(t) }); var n = { GroupId: t, Components: r }; e.push(n) }); var r = $("#ProductId").val(); $.ajax({ url: "/Products/ChangePriority", type: "POST", data: { productId: r, variantGroups: JSON.stringify(e) }, success: function () { LoadComponent("") }, error: function (t) { toastr.error(t) } }) } $(window).on("load", function () { initialize(), LoadComponent(""), SelectLJH($("select")), $("#FormProduct input, #FormProduct select").on("change", function () { var t = $("#ProductId").val(), a = $(this).attr("name"), e = $(this).val(); $.ajax({ type: "POST", url: "/Products/SaveProduct", data: { productId: t, name: a, value: e }, success: function () { } }) }), $("#DivEditPart").on("show.bs.modal", function () { var t = $("#EditVariantId").val(); $.getJSON("/Products/LoadEditModel/", { variantId: t }).done(function (t) { var a = t.ProductsList, e = t.GroupList, r = t.SelectItem, n = $("#EditProduct"); n.empty(), $.each(a, function () { var t = $("<option>", { value: this.Id, text: this.Model + " [" + this.Title + "]", "data-title": this.Title }); n.append(t) }), n.on("change", function () { var t = $(this.selectedOptions).attr("data-title"); $("#EditName").val(t) }); var o = $("#EditGroup"); o.empty(), $.each(e, function () { var t = $("<option>", { value: this.Id, text: this.Name }); o.append(t) }); var i = $("#FormEditPart input, #FormEditPart select"); $.each(i, function () { $(this).val(r[this.name]), $(this).is("select") ? SelectLJH($(this)) : $(this).trigger("change") }), SelectLJH(n) }).fail(function (t, a, e) { toastr.error("Load component", "Error", { positionClass: "toast-bottom-right" }) }) }), $("#BtnSubmitEdit").click(function () { $.ajax({ url: "/Products/SubmitEditPart/", data: $("#FormEditPart").serialize(), success: function () { $("#DivEditPart").modal("toggle"), LoadComponent("") }, error: function (t, a, e) { toastr.error("Save edit component", "code:" + t.status + "\n message::" + t.responseText + "\n error:" + e) } }) }), $("#chkAll").click(function () { var t = $("#chkAll").prop("checked"), a = $("#TbComponent > tbody > tr > td > input"); $(a).each(function () { $(this).prop("checked", t) }) }), $("#TbComponent").delegate("tr", "click", function (t) { if ("checkbox" !== $(t.target).prop("type")) { var a = $(t.currentTarget).find('input[type="checkbox"]'); a.prop("checked", !a.prop("checked")) } $(t.currentTarget).toggleClass("table-active") }), $("#TbSearchParts").delegate("button", "click", function (t) { AddPart($(this).parent().parent().children().children('input[type="hidden"]').val(), $(this).parent().parent().children().children('span[data-type="name"]').text(), $(this).parent().parent().children().children('span[data-type="model"]').text()) }), $("#TbAddParts").delegate("button", "click", function (t) { $(this).parent().parent().remove() }), $("#DivEditPart input").keydown(function (t) { 13 === t.keyCode && $("#BtnSubmitEdit").trigger("click") }), $(".filebox .upload-hidden").on("change", function () { if ($(this)[0].files[0], window.FileReader) var t = $(this)[0].files[0].name; else t = $(this).val().split("/").pop().split("\\").pop(); var a = $(this).siblings(".upload-name"); a.val(t), a.attr("title", t) }), $("#ManualList").delegate("tr", "click", function (t) { if ("checkbox" !== $(t.target).prop("type")) { var a = $(t.currentTarget).find('input[type="checkbox"]'); a.prop("checked", !a.prop("checked")), $(t.currentTarget).toggleClass("table-active") } }), $("#DivVariantGroup").on("show.bs.modal", function () { LoadVariantGroup() }), $("#BtnAddGroup").on("click", function () { var t = $("#AddGroup").val(); $.ajax({ url: "/Products/AddVariantGroup", type: "POST", data: { groupName: t }, success: function () { toastr.success("Success add"), LoadVariantGroup() }, error: function (t) { toastr.error(t) } }) }), $("#AddGroup").keydown(function (t) { 13 === t.keyCode && $("#BtnAddGroup").trigger("click") }), $("#DivAddParts").on("show.bs.modal", function () { SearchParts(), $.getJSON("/Products/LoadVariantGroup", function (t) { vatGroupList = t }) }), $("#SearchPart").on("input", function () { SearchParts() }), $("#BtnSubmitAddParts").click(function () { loading.show(); var t = new Array, a = $("#SelectParts .form-group.row"); $.each(a, function () { var a = { Group: $(this).find(".vatGroup").val(), Id: $(this).find(".component").val() }; t.push(a) }); var e = { MainId: $("#ProductId").val(), Component: t }, r = JSON.stringify(e); $.ajax({ type: "POST", url: "/Products/SaveComponent/", data: { json: r }, success: function (t) { $("#DivAddParts").modal("toggle"), LoadComponent(""), loading.hide(), a.remove() } }) }), $("#BtnDeleteParts").click(function () { loading.show(); var t = new Array; $.each($("#TbComponent input:checked"), function () { t.push(this.value) }); var a = $("#ProductId").val(); $.ajax({ url: "/Products/DeleteComponents", type: "POST", data: { json: JSON.stringify(t), productId: a }, success: function () { $("#DivDeletePart").modal("hide"), LoadComponent(""), loading.hide() }, error: function (t) { toastr.error(t) } }) }), $("#DivNewPart input").keydown(function (t) { 13 === t.keyCode && $("#SubmitNewPart").trigger("click") }), $("#SubmitNewPart").on("click", function () { var t = $("#NewPart").val(), a = $("#NewDesc").val(), e = $("#NewMass").val(); $.ajax({ url: "/Products/NewPart", type: "POST", data: { model: t, desc: a, mass: e }, success: function () { $("#DivNewPart").modal("hide"), SearchParts() }, error: function (t, a, e) { toastr.error("code:" + t.status + "\nmessage:" + t.responseText + "\nerror:" + e) } }) }) });